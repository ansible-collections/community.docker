---
# Copyright (c) Ansible Project
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

- name: Registering container name
  set_fact:
    pname: "{{ cname_prefix }}"
    cname: "{{ cname_prefix ~ '-hi' }}"
- name: Registering container name
  set_fact:
    cnames: "{{ cnames + [pname ~ '-' ~ cname] }}"
    dnetworks: "{{ dnetworks + [pname ~ '_default'] }}"

- name: Store service definitions
  set_fact:
    test_service: |
      version: '3.3'
      services:
        {{ cname }}:
          image: "{{ docker_test_image_alpine }}"
          container_name: {{ cname }}
          command: '/bin/sh -c "sleep 10m"'
          stop_grace_period: 1s
    test_service_mod: |
      version: '3.3'
      services:
        {{ cname }}:
          image: "{{ docker_test_image_alpine }}"
          container_name: {{ cname }}
          command: '/bin/sh -c "sleep 15m"'
          stop_grace_period: 1s

####################################################################
## Present #########################################################
####################################################################

- name: Present
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: present
    definition: "{{ test_service | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: present_1

- name: Present (idempotent)
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: present
    definition: "{{ test_service | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: present_2

- name: Present (changed)
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: present
    definition: "{{ test_service_mod | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: present_3

- assert:
    that:
    - present_1 is changed
    - "present_1.containers | length == 1"
    - "cname in present_1.containers"
    - "present_1.containers[cname] | length == 2"
    - "'created' in present_1.containers[cname]"
    - "'started' in present_1.containers[cname]"
    - present_2 is not changed
    - "present_1.containers | length == 1"
    - "cname in present_2.containers"
    - "present_2.containers[cname] | length == 1"
    - "'running' in present_2.containers[cname]"
    - present_3 is changed
    - "present_1.containers | length == 1"
    - "cname in present_3.containers"
    - "present_3.containers[cname] | length == 2"
    - "'recreated' in present_3.containers[cname]"
    - "'started' in present_3.containers[cname]"

####################################################################
## Absent ##########################################################
####################################################################

- name: Absent
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: absent
    definition: "{{ test_service_mod | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: absent_1

- name: Absent (idempotent)
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: absent
    definition: "{{ test_service_mod | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: absent_2

- assert:
    that:
    - absent_1 is changed
    - "absent_1.containers | length == 1"
    - "cname in absent_1.containers"
    - "absent_1.containers[cname] | length == 2"
    - "'stopped' in absent_1.containers[cname]"
    - "'removed' in absent_1.containers[cname]"
    - absent_2 is not changed
    - "absent_2.containers | length == 0"

####################################################################
## Stopping and starting ###########################################
####################################################################

- name: Create
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: created
    definition: "{{ test_service | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: present_1

- name: Present stopped (idempotent)
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: stopped
    definition: "{{ test_service | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: present_2

- name: Started
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: present
    definition: "{{ test_service | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: started_1

- name: Started (idempotent)
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: present
    definition: "{{ test_service | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: started_2

- name: Stopped
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: stopped
    definition: "{{ test_service | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"
  register: stopped_1

- name: Cleanup
  docker_compose_v2:
    project_name: "{{ pname }}"
    state: absent
    definition: "{{ test_service | from_yaml }}"
    project_src: "{{ remote_tmp_dir }}"

- assert:
    that:
    - present_1 is changed
    - "present_1.containers | length == 1"
    - "cname in present_1.containers"
    - "present_1.containers[cname] | length == 1"
    - "'created' in present_1.containers[cname]"
    # I believe output from docker-compose for the following case is wrong. I'm
    # commenting out assertions for now until we find a fix with docker-compose
    # developers.
    #- present_2 is not changed
    #- "present_2.containers | length == 0"
    - started_1 is changed
    - "started_1.containers | length == 1"
    - "cname in started_1.containers"
    - "started_1.containers[cname] | length == 1"
    - "'started' in present_1.containers[cname]"
    - started_2 is not changed
    - "started_2.containers | length == 1"
    - "cname in started_2.containers"
    - "started_2.containers[cname] | length == 1"
    - "'running' in present_1.containers[cname]"
    - stopped_1 is changed
    - "stopped_1.containers | length == 1"
    - "cname in stopped_1.containers"
    - "stopped_1.containers[cname] | length == 1"
    - "'stopped' in stopped_1.containers[cname]"

---
# Copyright (c) Ansible Project
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

- name: Registering container name
  set_fact:
    pname: "{{ cname_prefix }}"
    cname: "{{ cname_prefix ~ '-hi' }}"
- name: Registering container name
  set_fact:
    cnames: "{{ cnames + [pname ~ '-' ~ cname] }}"
    dnetworks: "{{ dnetworks + [pname ~ '_default'] }}"

- name: Store service definitions
  vars:
    test_service: |
      version: '3.3'
      services:
        {{ cname }}:
          image: "{{ docker_test_image_alpine }}"
          container_name: {{ cname }}
          command: '/bin/sh -c "sleep 10m"'
          stop_grace_period: 1s
    test_service_mod: |
      version: '3.3'
      services:
        {{ cname }}:
          image: "{{ docker_test_image_alpine }}"
          container_name: {{ cname }}
          command: '/bin/sh -c "sleep 15m"'
          stop_grace_period: 1s

  block:
    - name: Create directory
      file:
        path: '{{ remote_tmp_dir }}/{{ pname }}'
        state: directory

    - name: Create docker-compose.yml file
      copy:
        content: '{{ test_service | string }}'
        dest: '{{ remote_tmp_dir }}/{{ pname }}/docker-compose.yaml'

    ####################################################################
    ## Present #########################################################
    ####################################################################

    - name: Present
      docker_compose_v2:
        state: present
        files:
          - "{{ remote_tmp_dir }}/{{ cname_prefix }}/docker-compose.yaml"
      register: present_1

    - name: Present (idempotent)
      docker_compose_v2:
        state: present
        files:
          - "{{ remote_tmp_dir }}/{{ cname_prefix }}/docker-compose.yaml"
      register: present_2

    - name: Update docker-compose.yml file
      copy:
        content: '{{ test_service_mod | string }}'
        dest: '{{ remote_tmp_dir }}/{{ pname }}/docker-compose.yaml'

    - name: Present (changed)
      docker_compose_v2:
        state: present
        files:
          - "{{ remote_tmp_dir }}/{{ cname_prefix }}/docker-compose.yaml"
      register: present_3

    - assert:
        that:
        - present_1 is changed
        - "cname in present_1.containers"
        - "present_1.containers[cname] | length == 2"
        - "'created' in present_1.containers[cname]"
        - "'started' in present_1.containers[cname]"
        - present_2 is not changed
        - "cname in present_2.containers"
        - "present_2.containers[cname] | length == 1"
        - "'running' in present_2.containers[cname]"
        - present_3 is changed
        - "cname in present_3.containers"
        - "present_3.containers[cname] | length == 2"
        - "'recreated' in present_3.containers[cname]"
        - "'started' in present_3.containers[cname]"

    ####################################################################
    ## Absent ##########################################################
    ####################################################################

    - name: Absent (check)
      docker_compose_v2:
        state: absent
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
      check_mode: true
      register: absent_1

    - name: Absent
      docker_compose_v2:
        state: absent
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
      register: absent_2

    - name: Absent (idempotent)
      docker_compose_v2:
        state: absent
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
      register: absent_3

    - name: Absent (idempotent check)
      docker_compose_v2:
        state: absent
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
      check_mode: true
      register: absent_4

    - assert:
        that:
        - absent_1 is changed
        - absent_2 is changed
        - absent_3 is not changed
        - absent_4 is not changed

    ####################################################################
    ## Stopping and starting ###########################################
    ####################################################################

    - name: Update docker-compose.yml file
      copy:
        content: '{{ test_service | string }}'
        dest: '{{ remote_tmp_dir }}/{{ pname }}/docker-compose.yaml'

    - name: Present stopped (check)
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
        stopped: true
      check_mode: true
      register: present_1

    - name: Present stopped
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
        stopped: true
      register: present_2

    - name: Present stopped (idempotent)
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
        stopped: true
      register: present_3

    - name: Present stopped (idempotent check)
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
        stopped: true
      check_mode: true
      register: present_4

    - name: Started (check)
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
      check_mode: true
      register: started_1

    - name: Started
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
      register: started_2

    - name: Started (idempotent)
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
      register: started_3

    - name: Started (idempotent check)
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
      check_mode: true
      register: started_4

    - name: Stopped (check)
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
        stopped: true
      check_mode: true
      register: stopped_1

    - name: Stopped
      docker_compose_v2:
        state: present
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"
        stopped: true
      register: stopped_2

    - name: Cleanup
      docker_compose_v2:
        state: absent
        project_src: "{{ remote_tmp_dir }}/{{ cname_prefix }}"

    - assert:
        that:
        - present_1 is changed
        - present_2 is changed
        - present_3 is not changed
        - present_4 is not changed
        - started_1 is changed
        - started_2 is changed
        - started_3 is not changed
        - started_4 is not changed
        - stopped_1 is changed
        - stopped_2 is changed

  always:
    - name: Clean up
      docker_compose_v2:
        state: absent
        files:
          - "{{ remote_tmp_dir }}/{{ cname_prefix }}/docker-compose.yaml"
